<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/iron-icons/notification-icons.html">
<link rel="import" href="bower_components/iron-icons/editor-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html" >
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html" >
<link rel="import" href="bower_components/paper-styles/paper-styles.html">
<link rel="import" href="sig-add.html">
<link rel="import" href="sig-add-client.html">


<dom-module id="sig-list">
	<template>
		<style>
			:host {
				display: inline-block;
				height:95%;
			}
			iron-icon {
				fill: rgba(0,0,0,0);
				stroke: currentcolor;
			} 
			:host([pressed]) iron-icon {
				fill: currentcolor;
			}
			paper-button{   
				color: white;
				font-weight: bold;
			}

			#subscriber{
				width:3%;
			}
			.addItems{
				right: 2%;
				position: fixed;
				bottom: 5%;
				z-index: 100;
			}
		</style>

		<div class="addItems">
			<paper-fab icon="add" on-click = "showAddModal"></paper-fab>
		</div>

		<style include="shared-styles">
			:host {
				display: block;
				padding: 10px;
			}
			paper-fab { 
				--paper-fab-background: #7d8ff5;
				--paper-fab-keyboard-focus-background: var(--paper-light-blue-900); }
				vaadin-grid{font-size: 16px;}
				vaadin-grid col {font-size: 46px;}
			.edit{
				background: #81C784;
			}
			paper-button[raised] {
			  background: #FF8A80;
			}

			paper-tab.iron-selected {
			    background-color: var(--paper-indigo-500);
				 color:#E8EAF6;
			}
			paper-button.cancle-btn {
				color: #7d8ff5;
				font-weight:normal;
			}

		</style>

		<paper-dialog id="modal1" modal style="width:60%;">
			<paper-tabs selected="{{selected}}">
					  <paper-tab id="authen"> 
							<h2 >Authentication</h2>
					  </paper-tab>
					 <paper-tab id="autho">
							<h2>Authorizarion</h2>
					 </paper-tab>
			</paper-tabs>
								<paper-tooltip for="authen">Credentials used to authenticate subscriber</paper-tooltip>
								<paper-tooltip for="autho">Services authorized for subscriber</paper-tooltip>

			<iron-pages selected="{{selected}}">
				<div id="edit-password" >
					<paper-input id="edit-id1" name="id" label="Identity" disabled></paper-input>
					<paper-input id="edit-pwd" name="password"  label="Secret" disabled ></paper-input>
					<paper-input id="edit-new-pwd" name="newpassword" label="New Secret" required auto-validate error-message="New secret can't be empty!" ></paper-input>
					<div class="buttons">
						<paper-button on-click="cancel" class="cancle-btn">Cancel</paper-button>
						<paper-button dialog-confirm autofocus on-click="updatePassword" class="edit">Update Authentication</paper-button>
						<paper-button toggles raised on-click = "deleteSeletedItems"  > Delete Subscriber</paper-button>
					</div>
				</div>
				<div id="edit-attributes" >
					<paper-input id="edit-id2" name="id" label="Identity" disabled></paper-input>
					<div>
						<paper-input id="edit-balance" name="balance" type="number" label="Balance (Bytes)" ></paper-input>
						<paper-tooltip >Credit value, in bytes, against which accounting will debit usage against</paper-tooltip>
					</div>
					<div>
						<paper-input id="edit-recv-data-rate" name="ascendDataRate" type="number" label="Receive Data Rate"  ></paper-input>
						<paper-tooltip >Limit on received (download) data per second in bits</paper-tooltip>
					</div>
					<div>
						<paper-input id="edit-trans-data-rate" name="ascendXmitRate" type="number" label="Transmit Data Rate"  ></paper-input>
						<paper-tooltip >Limit on transmitted (upload) data per second in bits</paper-tooltip>
					</div>
					<div>
						<paper-input id="edit-sess-timeout" name="sessionTimeout" type="number" label="Session Timeout"  ></paper-input>
						<paper-tooltip >Time between authorization requests in an active session in seconds</paper-tooltip>
					</div>
					<div>
						<paper-input id="edit-update-interval" name="acctInterimInterval" type="number" label="Accouting interval"  ></paper-input>
						<paper-tooltip >Time between accouting interim updates in seconds</paper-tooltip>
					</div>
					<div>
						<paper-input id="edit-class" name="class" type="text" label="Class" ></paper-input>
					</div></br>
					<div>
						Enable <div style="display:inline-block;"> <paper-toggle-button id="edit-enabled"></paper-toggle-button> </div>
						<paper-tooltip >Enabled for service or temporarily disabled</paper-tooltip>
					</div>
					<div class="buttons">
						<paper-button on-click="cancel" class="cancle-btn">Cancel</paper-button>
						<paper-button dialog-confirm autofocus on-click="updateAttributes" class="edit">Update Authorizarion</paper-button>
						<paper-button toggles raised on-click = "deleteSeletedItems"  > Delete Subcriber</paper-button>
					</div>
					</div>
			</iron-pages>
		</paper-dialog>

		<paper-dialog id="modal4" modal style="width:60%;">
			<paper-tabs selected="{{selected}}">
					  <paper-tab id="authen"> 
							<h2 >Authentication</h2>
					  </paper-tab>
					 <paper-tab id="autho">
							<h2>Authorizarion</h2>
					 </paper-tab>
			</paper-tabs>
								<paper-tooltip for="authen">Credentials used to authenticate subscriber</paper-tooltip>
								<paper-tooltip for="autho">Services authorized for subscriber</paper-tooltip>

			<iron-pages selected="{{selected}}">
				<div id="edit-client-password" >
					<div >
						<paper-input id="edit-client-id1" name="id" label="Address" disabled></paper-input>
					</div>
					<div>
						<paper-input id="edit-client-pwd" name="password"  label="Secret" disabled ></paper-input>
					</div>
					<div>
						<paper-input id="edit-client-new-pwd" name="secret" label="New Secret"  ></paper-input>
						<paper-tooltip>Secret, or password, shared with the network access server, router or access point.</paper-tooltip>
					</div>
					<div class="buttons">
						<paper-button on-click="cancel" class="cancle-btn">Cancel</paper-button>
						<paper-button dialog-confirm autofocus on-click="updateClientPassword" class="edit">Update Authentication</paper-button>
						<paper-button toggles raised on-click = "deleteClient"  > Delete Client</paper-button>
					</div>
				</div>
					</div>
				<div id="edit-client-attributes" >
					<div >
						<paper-input id="edit-client-id2" name="id" label="IP Address" disabled></paper-input>
					</div>
					<div>
						<paper-input id="edit-client-disc-port" name="disconnectPort" label="Disconnect Port" type="number"></paper-input>
						<paper-tooltip >Disconnect port used in network access server, router or access point.</paper-tooltip>
					</div>

					<div>
						<template is="dom-bind">
							<paper-dropdown-menu id="edit-client-protocol" label="Protocol" selected-item-label="{{selectedItem}}">
								<paper-listbox id="protocol-menu" class="dropdown-content">
									<paper-item value="RADIUS">RADIUS</paper-item>
									<paper-item value="DIAMETER" disabled>DIAMETER</paper-item>
								</paper-listbox>
							</paper-dropdown-menu>
							<input is="iron-input" name="protocol" type="hidden" value$="[[selectedItem]]">
							<paper-tooltip >Protocol used by network access server, router or access point.</paper-tooltip>
						</template>
					</div>
					<div class="buttons">
						<paper-button on-click="cancel" class="cancle-btn">Cancel</paper-button>
						<paper-button dialog-confirm autofocus on-click="updateClientAttributes" class="edit">Update Authorization</paper-button>
						<paper-button toggles raised on-click = "deleteClient"  > Delete Client</paper-button>
					</div>
				</div>
					</div>
			</iron-pages>
		</paper-dialog>

		<paper-dialog id="modal2" modal style="width:60%; height: 70%; top:10%;">
			<sig-add ></sig-add>
		</paper-dialog>

		<paper-dialog id="modal3" modal style="width:60%; height: 43%; top:30%;">
			<sig-add-client></sig-add-client>
		</paper-dialog>

		<vaadin-grid selection-mode="single" id="frozen" frozen-columns="2" style="height:95%;">
			<table>
				<colgroup> 
				</colgroup>
				<thead>
				</thead>
			</table>
		</vaadin-grid>

		<paper-toast id="edit-toast">
			<h2>Record sucessfully updated !</h2>
		</paper-toast>

		<paper-toast id="delete-toast">
			<h2>Record sucessfully deleted !</h2>
		</paper-toast>

		<iron-ajax id="getClients"
			auto=false
			url="/ocs/v1/client"
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="clientResponseHandler"
			debounce-duration="10"> </iron-ajax>

		<iron-ajax id="getSubs"
			auto=false
			url="/ocs/v1/subscriber"
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="responseHandler"
			debounce-duration="10"> </iron-ajax>

		<iron-ajax id="updateClientPassword"
			auto=true
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="updateClientPwdResponseHandler"
			debounce-duration="300"> </iron-ajax>

		<iron-ajax id="updateClientAttributes"
			auto=true
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="updateClientAttrResponseHandler"
			debounce-duration="300"> </iron-ajax>

		<iron-ajax id="updatePassword"
			auto=true
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="updatePwdResponseHandler"
			debounce-duration="300"> </iron-ajax>

		<iron-ajax id="updateAttributes"
			auto=true
			headers='{"Accept": "application/json", "Content-type": "application/json"}'
			on-response="updateAttrResponseHandler"
			debounce-duration="300"> </iron-ajax>
					 
		<iron-ajax	 id="deleteClient"
			auto=false
			handle-as="json"
			method = "delete"
			on-response="deletionClientResponse"
			debounce-duration="300"> </iron-ajax>

		<iron-ajax	 id="deleteSubs"
			auto=false
			handle-as="json"
			method = "delete"
			on-response="deletionResponse"
			debounce-duration="300"> </iron-ajax>

	</template>

	<script>
		Polymer({
		  is: 'sig-list',

		properties:{
		},

		listeners: {
				'frozen.click': 'onSelect'
		},

		created: function() {
		},

		ready: function() {
		},

		clientResponseHandler: function(event) {
			var grid = this.$.frozen; 
			grid.columns = [
									{ name: "id"},
									{ name: "secret"},
									{ name: "disconnectPort"},
									{ name: "protocol"}
								];
			grid.items = event.detail.xhr.response;
			grid.header.getCell(0,0).content = '<div style="font-size:16px;"><div>Address</div><paper-tooltip >IP address of network access server, router or access point</paper-tooltip></div>';
			grid.header.getCell(0,1).content = '<div style="font-size:16px;"><div>Secret</div><paper-tooltip>Secret, or password, shared with the network access server, router or access point</paper-tooltip></div>';
			grid.header.getCell(0,2).content = '<div style="font-size:16px;"><div>Disconnect <br>Port</div><paper-tooltip>Disconnect port used by network access server, router or access point</paper-tooltip></div>';
			grid.header.getCell(0,3).content = '<div style="font-size:16px;"><div>Protocol</div><paper-tooltip>AAA protocol used by the network access server, router or access point</paper-tooltip></div>';
			grid.visibleRows =17;
			document.getElementById("progressbar").indeterminate = false;
		},




		responseHandler: function(event) {
			var grid = this.$.frozen; 
			var results = event.detail.xhr.response;
			var vaadinItems = new Array();

			for(var index in results){
					  var newRecord = new Object();
					  newRecord.id = results[index].id;
					  newRecord.password = results[index].password;
					  newRecord.balance = results[index].balance;

					 results[index].attributes.forEach(function(attrObj){
							newRecord[attrObj.name] = attrObj.value;
						});

					  newRecord.enabled = results[index].enabled;

					  vaadinItems[index] = newRecord;;
			}

			grid.items = vaadinItems;
			grid.visibleRows =17;
			grid.columns = [
									{ name: "id"},
									{ name: "password" },
									{ name: "balance"},
									{ name: "ascendDataRate"},
									{ name: "ascendXmitRate" },
									{ name: "sessionTimeout"},
									{ name: "acctInterimInterval"},
									{ name: "class"},
									{ name: "enabled"}
								];
			grid.header.getCell(0,0).content = '<div style="font-size:16px"><div> Identity</div> <paper-tooltip >Identity, or username, of the subscriber to authenticate</paper-tooltip></div>';
			grid.header.getCell(0,1).content = '<div style="font-size:16px"><div>Secret</div><paper-tooltip>Secret, or password, shared only with the subscriber</paper-tooltip></div>';
			grid.header.getCell(0,2).content = '<div style="font-size:16px"><div>Balance</div><paper-tooltip>Current credit value,in bytes against which accounting will debit usage against</paper-tooltip></div>';
			grid.header.getCell(0,3).content = '<div style="font-size:16px"><div>Data Rate</div><paper-tooltip>Limit on received (download) data per second in bits.</paper-tooltip></div>' ;
			grid.header.getCell(0,4).content = '<div style="font-size:16px"><div>Xmit Rate</div><paper-tooltip>Limit on transmitted (upload) data per second in bits.</paper-tooltip></div>' ;
			grid.header.getCell(0,5).content = '<div style="font-size:16px"><div>Session <br>Timeout</div><paper-tooltip>Time between authorization requests in an active session in seconds</paper-tooltip></div>';
			grid.header.getCell(0,6).content = '<div style="font-size:16px"><div>Accounting <br>Interval</div><paper-tooltip>Time between accounting interim updates in seconds</paper-tooltip></div>';
			grid.header.getCell(0,7).content = '<div style="font-size:16px"><div>Class</div><paper-tooltip>Lable used in accounting records</paper-tooltip></div>';
			grid.header.getCell(0,8).content = '<div style="font-size:16px"><div>Enabled</div><paper-tooltip >Authorization temporarily enabled, or disabled.</paper-tooltip></div>';
			document.getElementById("progressbar").indeterminate = false;
		},

		gotoEnd: function(event){
			var grid = this.$.frozen; 
			grid.scrollToEnd();
		},

		showAddModal: function(event){
			if(window.selection == "selectionSubscribers"){
				var modal = this.$.modal2;
				modal.open();
			}
			if(window.selection == "selectionRadiusClients"){
				var modal = this.$.modal3;
				modal.open();
			}

		},

		updateClientPassword: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var editAjax =  document.getElementById("updateClientPassword");
			editAjax.method = "PATCH";
			editAjax.contentType = "application/json";
			var id = document.getElementById("edit-client-id1").value;
			editAjax.url = "/ocs/v1/client/" + id;
			var client = new Object();
			client.password = document.getElementById("edit-client-new-pwd").value;
			editAjax.body = client;
		},

		updateClientAttributes: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var editAjax =  document.getElementById("updateClientAttributes");
			editAjax.method = "PATCH";
			editAjax.contentType = "application/json";
			var id = document.getElementById("edit-client-id2").value;
			editAjax.url = "/ocs/v1/client/" + id;
			var client = new Object();
			client.disconnectPort = parseInt(document.getElementById("edit-client-disc-port").value);
			client.protocol = document.getElementById("edit-client-protocol").value;
			editAjax.body = client;
			editAjax.generateRequest();
		},


		updatePassword: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var editAjax =  document.getElementById("updatePassword");
			editAjax.method = "PATCH";
			editAjax.contentType = "application/json";
			var id = document.getElementById("edit-id1").value;
			editAjax.url = "/ocs/v1/subscriber/" + id;
			var sub = new Object();
			sub.update = "password";
			sub.newpassword = document.getElementById("edit-new-pwd").value;
			editAjax.body = sub;
		},

		updateAttributes: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var editAjax =  document.getElementById("updateAttributes");
			editAjax.method = "PATCH";
			editAjax.contentType = "application/json";
			var id = document.getElementById("edit-id2").value;
			editAjax.url = "/ocs/v1/subscriber/" + id;
			var sub = new Object();
			sub.update = "attributes";
			sub.balance= parseInt(document.getElementById("edit-balance").value);
			var attr = new Array();

			var ascendDataRate = new Object();
			ascendDataRate.name = "ascendDataRate";
			ascendDataRate.type = 26;
			ascendDataRate.vendorId = 529;
			ascendDataRate.vendorType = 197;
			ascendDataRate.value = parseInt(document.getElementById("edit-recv-data-rate").value);
			attr[0] = ascendDataRate;

			var ascendXmitRate = new Object(); 
			ascendXmitRate.name = "ascendXmitRate";
			ascendXmitRate.type = 26;
			ascendXmitRate.vendorId = 529;
			ascendXmitRate.vendorType = 255;
			ascendXmitRate.value = parseInt(document.getElementById("edit-trans-data-rate").value);
			attr[1] = ascendXmitRate;

			var sessionTimeout = new Object(); 
			sessionTimeout.name = "sessionTimeout"; 
			sessionTimeout.value = parseInt(document.getElementById("edit-sess-timeout").value);
			attr[2] = sessionTimeout;

			var acctInterimInterval = new Object(); 
			acctInterimInterval.name = "acctInterimInterval"; 
			acctInterimInterval.value = parseInt(document.getElementById("edit-update-interval").value);
			attr[3] = acctInterimInterval;

			var classx = new Object(); 
			classx.name = "class"; 
			if(document.getElementById("edit-class").value == undefined){
				classx.value = null;
			}else{
				classx.value = document.getElementById("edit-class").value;
			}
			attr[4] = classx;

			sub.attributes = attr;
			sub.enabled= document.getElementById("edit-enabled").checked;
			editAjax.body = sub;
		},

		updateClientPwdResponseHandler: function (event){
			if(event.detail.succeeded){
				document.getElementById("edit-toast").open();
				document.getElementById("edit-client-new-pwd").value = "";
				var getClientsAjax = document.getElementById("getClients");
				getClientsAjax.generateRequest();
				document.getElementById("progressbar").indeterminate = false;
			}
			else{
				console.log("Not Success");
			}
		},

		updateClientAttrResponseHandler: function (event){
			if(event.detail.succeeded){
				document.getElementById("edit-toast").open();
				document.getElementById("edit-client-new-pwd").value = "";
				var getClientsAjax = document.getElementById("getClients");
				getClientsAjax.generateRequest();
				document.getElementById("progressbar").indeterminate = false;
			}
			else{
				console.log("Not Success");
			}
		},

		updatePwdResponseHandler: function (event){
			if(event.detail.succeeded){
				document.getElementById("edit-toast").open();
				document.getElementById("edit-new-pwd").value = "";
				var getSubsAjax = document.getElementById("getSubs");
				getSubsAjax.generateRequest();
				document.getElementById("progressbar").indeterminate = false;
			}
			else{
				console.log("Not Success");
			}
		},

		updateAttrResponseHandler: function (event){
			if(event.detail.succeeded){
				document.getElementById("edit-toast").open();
				var getSubsAjax = document.getElementById("getSubs");
				getSubsAjax.generateRequest();
				document.getElementById("progressbar").indeterminate = false;
			}
			else{
				console.log("Not Success");
			}
		},
		  
		cancel: function(){
			this.$.modal1.close();
			this.$.modal2.close();
			this.$.modal3.close();
			this.$.modal4.close();
			document.getElementById("progressbar").indeterminate = false;
		},

		deleteClient: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var grid = this.$.frozen; 
			grid.selection.selected(function(index){
				var selection = grid.items[index];
				var deleteAjax = document.getElementById("deleteClient");
				deleteAjax.url = "/ocs/v1/client/"+ selection.id;
				deleteAjax.generateRequest();
			});
		},

		deletionClientResponse: function(event){
			this.$.modal4.close(); 
			document.getElementById("delete-toast").open();
			var getClientsAjax = document.getElementById("getClients");
			getClientsAjax.generateRequest();
			document.getElementById("progressbar").indeterminate = false;
		},

		deleteSeletedItems: function(event){
			document.getElementById("progressbar").indeterminate = true;
			var grid = this.$.frozen; 
			grid.selection.selected(function(index){
				var selection = grid.items[index];
				var deleteAjax = document.getElementById("deleteSubs");
				deleteAjax.url = "/ocs/v1/subscriber/"+ selection.id;
				deleteAjax.generateRequest();
			});
		},

		deletionResponse: function(event){
			this.$.modal1.close(); 
			document.getElementById("delete-toast").open();
			var getSubsAjax = document.getElementById("getSubs");
			getSubsAjax.generateRequest();
			document.getElementById("progressbar").indeterminate = false;
		},

		onSelect: function(event) {
			var grid = this.$.frozen; 

			if(window.selection == "selectionSubscribers"){
				var modal = this.$.modal1; 
				modal.open();
				grid.selection.selected(function(index) {
					var selection = grid.items[index];
					document.getElementById("edit-id1").value = selection.id;
					document.getElementById("edit-id2").value = selection.id;

					if(selection.password == ""){
						document.getElementById("edit-pwd").value = "[no secret]";
					}else{
						document.getElementById("edit-pwd").value = selection.password;
					}

					document.getElementById("edit-balance").value = selection.balance;
					document.getElementById("edit-recv-data-rate").value = selection.ascendDataRate;
					document.getElementById("edit-trans-data-rate").value = selection.ascendXmitRate;
					document.getElementById("edit-sess-timeout").value = selection.sessionTimeout;
					document.getElementById("edit-update-interval").value = selection.acctInterimInterval;
					document.getElementById("edit-class").value =  selection.class;
					document.getElementById("edit-enabled").checked =  selection.enabled;
				});}
				if(window.selection == "selectionRadiusClients"){
					var modal = this.$.modal4; 
					modal.open();
					grid.selection.selected(function(index) {
					var selection = grid.items[index];
					document.getElementById("edit-client-id1").value = selection.id;
					document.getElementById("edit-client-id2").value = selection.id;
					document.getElementById("edit-client-disc-port").value = selection.disconnectPort;
					document.getElementById("protocol-menu").selectedItemLabel = selection.protocol;

					switch(selection.protocol){
						case "RADIUS": document.getElementById("protocol-menu").selected=0; break;
						case "DIAMETER": document.getElementById("protocol-menu").selected=1; break;
					}

					document.getElementById("edit-client-pwd").value = selection.secret;
				});}

		}
	});
	</script>
</dom-module>
